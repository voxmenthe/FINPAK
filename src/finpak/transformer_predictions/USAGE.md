Usage


## V7
V7 (strict checkpoint compatibility)
- V7 expects identical input/output shapes when resuming from a checkpoint. You must keep the same feature/target counts and config dimensions.
- Use V7 if you are not changing the number/order of features or targets.

Examples (V7)
- Checkpoint path example:
  - "checkpoints/vMP007a_stability_e58_valloss_0.0004361_tc0_vc0.pt"
- Resume with identical dims:
  - python src/finpak/transformer_predictions/main_v7.py --config "vMP007a_stability_followon" --checkpoint "checkpoints/vMP007a_stability_e58_valloss_0.0004361_tc0_vc0.pt"
- Train fresh:
  - python src/finpak/transformer_predictions/main_v7.py --config "vMP007b_stability"

Additional V7 examples (same dims required)
- python src/finpak/transformer_predictions/main_v7.py --config "vMP007a_stability_followon_2" --checkpoint "checkpoints/vMP007b_stability_e248_valloss_0.0000600_tc10_vc0.pt"
- vMP007a_stability_followon_2_e620_valloss_0.0000486_tc12_vc0.pt
- python src/finpak/transformer_predictions/main_v7.py --config "vMP007a_stability" --checkpoint "checkpoints/vMP007a_stability_followon_2_e620_valloss_0.0000486_tc12_vc0.pt"

### Random Interesting Checkpoints
vMP007a_stability_e1142_valloss_0.0000357_tc12_vc0.pt


## V8
V8 (supports IO expansion + registry checks)
- V8 can expand input features and/or targets when resuming from a checkpoint.
- It will reuse the backbone and expand only IO layers when `--expand-checkpoint-io` is provided.
- Feature/target registry checks detect reorder/shrink; use `--enforce-registry` to fail fast.

Examples (V8)
- Train fresh:
  - python src/finpak/transformer_predictions/main_v8.py --config "vMP007b_stability"
- Resume with expanded IO + warmup:
  - python src/finpak/transformer_predictions/main_v8.py --config vMP007a_stability_followon --checkpoint checkpoints/…pt --expand-checkpoint-io --io-warmup-epochs 3
- Resume with custom init and registry enforcement:
  - python src/finpak/transformer_predictions/main_v8.py --config vMP007a_stability_followon --checkpoint checkpoints/…pt --expand-checkpoint-io --checkpoint-io-init normal --enforce-registry

### V8 resume with different feature/label counts
V8 only expands IO layers. If you change the number of features/targets (via `data_params`), use `--expand-checkpoint-io` or you will hit shape mismatches.

Allowed changes when resuming:
- Add new continuous/categorical features (append-only order).
- Add new targets (append-only order).

Not allowed (will warn or fail if `--enforce-registry`):
- Reorder existing features/targets.
- Remove (shrink) features/targets.

Registry behavior:
- V8 saves a feature/target registry in checkpoint metadata.
- On resume, V8 compares current registry vs checkpoint registry.
- If you are only appending, V8 will print added features/targets.
- If order/shrink differs, V8 prints a mismatch warning; add `--enforce-registry` to hard fail.
- Registry names are generated by feature/target builders in `preprocessing_v8.py` (driven by `data_params` like `return_periods`, `sma_periods`, `use_volatility`, `use_momentum`, `target_periods`, and bin configs). The registry is assembled in `create_subset_dataloaders(..., return_registry=True)` in `data_loading_v8.py`.

IO expansion details:
- Input projection expands for added continuous features.
- Output projection expands for added target outputs.
- Categorical projection heads expand to match new bins/heads.

### Warmup and key checkpoint arguments (V8)
Warmup is split into two parts:
- IO warmup (backbone freeze): use `--io-warmup-epochs N` when expanding IO. This freezes the backbone for N epochs while the IO layers adapt.
- LR warmup (scheduler): set `train_params.scheduler.warmup_epochs` in your config for learning-rate warmup.

Config snippet (LR warmup):
```
train_params:
  scheduler:
    type: warmup_decay
    base_lr: 1e-4
    max_lr: 1e-4
    min_lr: 1e-6
    warmup_epochs: 6
```

Checkpoint arguments:
- `--checkpoint`: path to the checkpoint to resume from.
- `--expand-checkpoint-io`: expand input/output layers to match new feature/target counts.
- `--checkpoint-io-init {zeros,normal,kaiming}`: init for new IO weights (default: zeros).
- `--strict-checkpoint`: enforce strict `state_dict` loading after expansion.
- `--enforce-registry`: fail fast on registry mismatch (reorder/shrink).
- `--io-warmup-epochs N`: freeze backbone for N epochs (IO layers train).
- `--unsafe-load-checkpoint`: only for trusted checkpoints; uses `torch.load(weights_only=False)`.

### Example: resume with extra features + targets
- Update config `data_params` to include new features/targets (append-only).
- Resume with IO expansion + warmup:
  - python src/finpak/transformer_predictions/main_v8.py --config vMP007a_stability_followon --checkpoint checkpoints/…pt --expand-checkpoint-io --checkpoint-io-init normal --io-warmup-epochs 3 --enforce-registry

# current example
# checkpoints/vMP007b_stability_e248_valloss_0.0000600_tc10_vc0.pt
python src/finpak/transformer_predictions/main_v8.py --config vMP007b_stability_followon --checkpoint checkpoints/vMP007b_stability_e248_valloss_0.0000600_tc10_vc0.pt --expand-checkpoint-io --checkpoint-io-init normal --enforce-registry
